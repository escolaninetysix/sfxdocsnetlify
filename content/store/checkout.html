{
"title": "Checkout",
"date": "2019-08-22T12:00:00.000Z"
}
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script src="//www.google-analytics.com/analytics.js"></script>
<script src="/currency.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.1/font/bootstrap-icons.css">

<style>
    label {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .grouped-input {
        margin: .25rem 0;
    }

    #payment-form-container {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: hidden;
        overflow-y: auto;
        width: 100%;
        height: 100%;
        max-height: 475px;
        background-color: white;
        border: solid 2px #26A9E0;
        box-sizing: border-box;
    }

    #billing-info-section,
    #payment-info-section {
        position: relative;
        top: 0;
        flex-basis: 100%;
        flex-shrink: 0;
        transition-duration: .3s;
        transition-timing-function: ease-out;
        width: 100%;
    }

    #billing-info-section.slide-show {
        right: 0;
    }

    #billing-info-section.slide-hide {
        right: 100%;
    }

    #payment-info-section.slide-show {
        right: 100%;
    }

    #payment-info-section.slide-hide {
        right: 0;
    }

    .submitting-overlay {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        z-index: 999;
    }
</style>

{{% spinner/md/style %}}

<div id="app">
    <div v-show="state.loading" style="height:640px;">Loading Checkout. . .</div>
    <div v-show="!state.loading" class="col">
        <h2>Checkout</h2>
        <div class="row">
            <div class="col-lg-5">
                <!-- Payment Details Form -->
                <div id="payment-form-container">
                    <div id="billing-info-section" class="slide-show p-3">
                        <form id="address-form" @submit.prevent="saveAddress">
                            <!-- Billing Address -->
                            <div class="form-group">
                                <h4>Invoicing Address</h4>
                                <p><em>Note: if you are purchasing on behalf of a business, please enter your business's
                                        billing address.</em></p>
                                <input type="text" class="form-control grouped-input" id="billing-address-1"
                                    v-model="billing.address.line1" placeholder="Line 1" :disabled="!canEditAddress()"
                                    required />
                                <input type="text" class="form-control grouped-input" id="billing-address-2"
                                    v-model="billing.address.line2" placeholder="Line 2 (Optional)"
                                    :disabled="!canEditAddress()" />
                                <input type="text" class="form-control grouped-input" id="billing-city"
                                    v-model="billing.address.city" placeholder="City" :disabled="!canEditAddress()"
                                    required />
                                <input type="text" class="form-control grouped-input" id="billing-zip"
                                    v-model="billing.address.zip" placeholder="Zip/Postal Code"
                                    :disabled="!canEditAddress()" required />
                                <select class="form-control grouped-input" id="billing-country"
                                    v-model="billing.address.country"
                                    @change="renderStates($event, $event.target.selectedIndex);"
                                    :disabled="!canEditAddress()" required>
                                    <option value="">Country</option>
                                    <option v-for="c in countries" :value="c.code">${ c.name }</option>
                                </select>
                                <select class="form-control grouped-input" id="billing-state" v-if="states"
                                    v-model="billing.address.state" :disabled="!canEditAddress()" required>
                                    <option value="">-- Select State --</option>
                                    <option v-for="s in states" :value="s.code">${ s.name }</option>
                                </select>
                            </div>
                            <div class="text-right" v-show="canEditAddress()"
                                style="display:flex; justify-content:right; column-gap:1rem;">
                                <div><button class="btn mx-auto" v-show="state.addressEditMode"
                                        @click='cancelAddressChange' :disabled="state.submitting">Cancel</button></div>
                                <div><button class="btn mx-auto" type="submit"
                                        :disabled="state.submitting">Save</button></div>
                            </div>
                        </form>

                        <div v-show="!canEditAddress()" style="display:flex; justify-content:right; column-gap:1rem;">
                            <div><button class="btn mx-auto" @click='state.addressEditMode = true;'
                                    :disabled="state.submitting">Edit</button></div>
                            <div><button class="btn mx-auto" @click='goToPaymentMethods'>Confirm</button></div>
                        </div>
                    </div>

                    <div id="payment-info-section" class="p-3 slide-hide">
                        <div class="submitting-overlay" v-show="state.submitting">
                            <div class="d-flex flex-column h-100 align-items-center justify-content-center">
                                {{% spinner/md/element %}}
                                <p style="color:26A9E0; font-weight: 700;">
                                    ${overlayText}
                                </p>
                            </div>
                        </div>
                        <form @submit.prevent='handleSubmit'>
                            <div class="payment-selection-container" class="my-auto">
                                <div v-show="currency(totals.total).value > 0">

                                    <!-- For Existing Saved Payment Methods -->
                                    <div class="form-group" v-show="stripe.customer.hasSavedCards">
                                        <h3>Select Payment Method</h3>
                                        <div class="radio">
                                            <template v-for="card in stripe.customer.cards">
                                                <label v-if="card.type == 'card'"><input type="radio"
                                                        name="paymentmethod" v-model="billing.pmId"
                                                        :value="card.stripeId">
                                                    <span class="ml-1 font-weight-normal">**** **** **** ${
                                                        card.lastFour }
                                                        - ${
                                                        card.brand } - Expires ${ card.endDate }</span>
                                                </label>
                                                <label v-if="card.type == 'ach'"><input type="radio"
                                                        name="paymentmethod" v-model="billing.pmId"
                                                        :value="card.stripeId">
                                                    <span class="ml-1 font-weight-normal">${ card.bankName } - Account
                                                        Ending in
                                                        ${ card.lastFour }</span>
                                                </label>
                                            </template>
                                        </div>
                                    </div>

                                    <div v-if="!stripe.customer.hasSavedCards">
                                        <h5>You have no saved payment methods.</h5>
                                    </div>
                                    <div>
                                        <a href="#" data-toggle="modal" data-target="#new-pm-modal">New Payment
                                            Method</a>
                                        <span>&nbsp;|&nbsp;</span>
                                        <a href="/account/payment-methods?ref=checkout">Manage Payment Methods</a>
                                    </div>
                                </div>
                                <div v-show="totals.total <= 0">
                                    <p><strong>No payment is required. Please select "Submit" to complete your
                                            order.</strong></p>
                                </div>
                                <div style="display:flex; justify-content:right; column-gap:1rem;">
                                    <div><button class="btn" type="button" @click="goToBillingInfo">Back</button></div>
                                    <div><button class="btn" type="submit"
                                            :disabled="state.submitting || (!billing.pmId && totals.total > 0)">${
                                            submitLabel}</button>
                                    </div>
                                </div>
                                <div class="form-group p-3" v-if="containsUS() && totals.total > 0">
                                    <input type="checkbox" class="form-check-input" id="autorenew" v-model="autorenew">
                                    <label class="font-weight-normal" for="autorenew">Renew my Upgrade &amp; Support
                                        Plan Automatically (renews annually)</label>
                                </div>
                        </form>
                    </div>
                </div>
            </div>
            <p style="font-size: .9rem" class="mt-3">Please note: Payment will be charged to your Boris FX account at
                the confirmation of purchase. Subscriptions and Upgrade and Support plans will
                automatically renew unless canceled at least 24 hours before the end of the current period. Your account
                will be charged for any automatic
                renewal within 24 hours prior to the end of the current period. You will be notified via email of an
                upcoming automatic renewal 30 days prior
                to the end of the current period for annual plans or 5 days prior for monthly plans. You can always
                manage and cancel automated billing by
                going to your Boris FX account settings after purchase.</p>
        </div>

        {{% new-payment-method-modal %}}

        <!-- Order Details -->
        <div class="col-lg-7 mt-5 mt-lg-0 pl-lg-5">
            <div class="row">
                <div class="col offset-lg-1">
                    <h3>Your Order:</h3>
                </div>
            </div>
            <!-- Line Items -->
            <div class="mb-4">
                <div class="row mb-2" v-for="item in checkout.lineItems" key="item.id">
                    <div class="col-5 offset-1">
                        <img :src="item.variant.image.src" class="img-fluid" />
                    </div>
                    <div class="col-6 my-auto">
                        <span style="font-weight:600">${ item.title }</span><br />
                        <span>${ item.variant.title } (${ item.quantity })</span><br />
                        <span style="font-weight:600">$${ item.variant.price.amount }</span>
                    </div>
                </div>
            </div>
            <div class="row" v-if="checkout.discountCodeApplicable == false">
                <div class="alert alert-warning"><i class="bi bi-exclamation-triangle-fill"
                        style="font-size:1.2rem;"></i> No products found for current discount code. No discount will be
                    applied.</div>
            </div>
            <div class="row">
                <!-- Discount Code Entry-->
                <div class="col-lg-5">
                    <div class="form-group">
                        <label>Discount Code</label>
                        <div class="input-group" v-if="!checkout.currentDiscountCode">
                            <input type="text" class="form-control" id="discount-code-input" />
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"
                                    style="font-size:1rem; margin-top:0;" v-on:click="applyDiscountCode">Apply</button>
                            </div>
                        </div>
                        <div class="discount-code-container" v-else>
                            <span class="font-weight-bold">${ checkout.currentDiscountCode } </span><a
                                class="font-weight-bold" href="#" v-on:click="clearDiscount">(Clear)</a>
                        </div>
                    </div>
                    <!-- VAT Number Entry -->
                    <div class="form-group" v-if="state.applyVat && billing.address.country != 'GB'">
                        <label>VAT Id Number</label>
                        <div class="input-group" v-bind:class="{ 'has-danger' : vat.error }" v-if="!vat.valid">
                            <div class="input-group-addon" v-if="billing.address.country">
                                <span class="input-group-text">${billing.address.country}</span>
                            </div>
                            <input type="text" class="form-control" id="vat-number-input" v-model="vat.number" />
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"
                                    style="font-size:1rem; margin-top:0;" v-on:click="validateVAT">Verify</button>
                            </div>
                        </div>
                        <div style="color:red; font-size: .8rem;" v-if="vat.error">
                            ${ vat.error }
                        </div>
                        <div class="font-weight-bold" v-if="vat.valid">
                            <span>Verified: ${ billing.address.country}${ vat.number }</span>
                        </div>
                    </div>
                </div>
                <!-- Totals -->
                <div class="col-lg-6">
                    <div class="row">
                        <div class="col-5 text-right">
                            <h5>Subtotal: </h5>
                            <h5>Discount: </h5>
                            <h5>Taxes: </h5>
                        </div>
                        <div class="col-7 text-right">
                            <h5>${ totals.subtotal } USD</h5>
                            <h5>${ totals.discount } USD</h5>
                            <h5>${ totals.taxes } USD</h5>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-5 text-right">
                            <h5>Total: </h5>
                        </div>
                        <div class="col-7 text-right">
                            <h5>${ totals.total } USD</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 mt-3">

        </div>
    </div>
    <div class="row">
        <div style="display: none;" id="hidden-content">
            {{ partial "product-login-cart.html" . }}
        </div>
    </div>
</div>
</div>
<script src="https://sdks.shopifycdn.com/js-buy-sdk/v2/latest/index.umd.min.js"></script>
<script>
    var shopifyClient = ShopifyBuy.buildClient({
        domain: 'borisfx.myshopify.com',
        storefrontAccessToken: '3f231af7322de13fabe8e3e7ff3ef003',
    });
</script>
{{% country-state-json %}}
{{% tax-json %}}
<script>
    const vatCountries = ['AD', 'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FO', 'FI', 'FR', 'DE', 'GI', 'GR', 'GL', 'GG', 'VA', 'HU', 'IS', 'IE', 'IM', 'IT', 'JE', 'LV', 'LI', 'LT', 'LU', 'MT', 'MC', 'NL', 'NO', 'PL', 'PT', 'RO', 'PM', 'SM', 'SK', 'SI', 'ES', 'SE', 'TR', 'GB']
</script>
<script>
    var vm = new Vue({
        el: '#app',
        delimiters: ['${', '}'],
        data: {
            user: Cookies.getJSON('bfx-login'),
            lockNewPmModal: false,
            state: {
                loading: true,
                isEmpty: true,
                submitting: false,
                paymentType: 'card',
                isImagineer: false,
                applyVat: false,
                addressEditMode: false
            },
            stripe: {
                stripeJs: undefined,
                elements: undefined,
                cardElement: undefined,
                customer: {
                    hasSavedCards: false,
                    hasSavedAddress: false,
                    address: {}
                }
            },
            plaid: {
                handler: undefined,
                publicKey: 'fa31534ec9f4ae2a91ed0cef838fea',
                plaidToken: undefined,
                selectedAccountId: '',
                accounts: [],
                institution: {}
            },
            totals: {
                subtotal: '0.00',
                discount: '0.00',
                taxRate: 0,
                taxes: '0.00',
                total: '0.00'
            },
            checkout: {
                lineItems: [],
                checkoutId: undefined,
                currentDiscountCode: undefined,
                discountCodeApplicable: null,
                paymentIntent: {},
                transactionId: '',
                opportunityId: '',
                orderId: ''
            },
            billing: {
                firstName: '',
                lastName: '',
                company: '',
                email: '',
                address: {
                    line1: '',
                    line2: '',
                    city: '',
                    state: '',
                    zip: '',
                    country: '',
                },
                pmId: '',
            },
            vat: {
                number: '',
                valid: false,
                error: undefined
            },
            attribution: {
                orderid: ''
            },
            countries: countryJson,
            states: undefined,
            taxRates: taxRates,
            ga: undefined,
            autorenew: true,
            overlayText: 'Please Wait'
        },
        created: function () {
            if (!this.user || !this.user.email_verified || this.user.email_verified == 'false') {
                Cookies.set('redirect_url', window.location.href)
                window.location.href = '/account/login';
                return;
            }
        },
        mounted: function () {
            var self = this;
            self.checkout.checkoutId = Cookies.get('bfx-checkout-id')
            if (!self.checkout.checkoutId) {
                self.state.empty = true
                self.state.loading = false
            } else {
                shopifyClient.checkout.fetch(self.checkout.checkoutId).then(function (shopifyCheckout) {
                    if (shopifyCheckout.orderStatusUrl) {
                        self.state.empty = true
                        self.state.loading = false
                        return
                    }
                    self.compileCheckout(shopifyCheckout);
                    self.initializePlaid();
                    self.getCustomer()
                        .then(function () {
                            self.gtmCheckoutEvent(shopifyCheckout.lineItems, 1);
                            self.state.empty = false;
                            self.state.loading = false;
                        })
                        .catch(function (err) {
                            if (err.response != null && err.response.status == 403) {
                                Cookies.set('bfx-login', '', { domain: window.location.hostname == 'localhost' ? 'localhost' : '.' + window.location.hostname, expires: -1 });
                                Cookies.set('redirect_url', window.location.href);
                                window.location.href = '/account/login?session_expired=true';
                            }
                            else {
                                alert('There was an error initializing checkout. Please contact us at customerservice@borisfx.com for assistance.');
                                window.location.href = "/store/cart"
                            }
                        })
                })
            }
        },
        methods: {
            // ***INITIALIZING FUNCTIONS ***
            // #init
            initializeStripe() {
                var stripe = this.stripe;
                let key = stripe.customer.gatewayKey;

                stripe.stripeJs = Stripe(key);
                stripe.elements = stripe.stripeJs.elements();
                stripe.cardElement = stripe.elements.create('card');
                stripe.cardElement.mount('#card-container');
            },
            initializePlaid: function () {
                var self = this,
                    plaid = self.plaid;
                plaid.handler = Plaid.create({
                    env: 'production',
                    clientName: 'Boris FX',
                    key: plaid.publicKey,
                    product: ['auth'],
                    onLoad: function () { },
                    onSuccess: function (token, metadata) {
                        self.plaid.accounts = metadata.accounts;
                        self.plaid.institution = metadata.institution;
                        self.plaid.plaidToken = token;
                    }
                })
            },
            //------------------------------------------------------------------------------

            // *** ADDRESS FUNCTIONS ***
            // #address
            //------------------------------------------------------------------------------
            saveAddress: function () {
                var self = this;
                payload = {
                    address: self.billing.address
                };
                axios.post('https://backend.borisfx.com/stripe_customer/address', payload, { auth: { username: self.user.email, password: self.user.token } })
                .then(function (res) {
                    var result = self.stripe.customer = res.data;
                    self.stripe.customer.hasSavedCards = result.cards.length > 0;
                    self.stripe.customer.hasSavedAddress = Object.keys(result.address).length > 0 && result.address.countryCode != null;
                    return self.getPaymentIntent();
                })
                .then(function (res) {
                    self.goToPaymentMethods();
                    self.state.addressEditMode = false;
                })
                .catch(function (err) {
                    if (err.response != null && err.response.status == 403) {
                        Cookies.set('bfx-login', '', { domain: window.location.hostname == 'localhost' ? 'localhost' : '.' + window.location.hostname, expires: -1 });
                        Cookies.set('redirect_url', window.location.href);
                        window.location.href = '/account/login?session_expired=true';
                    }
                    else alert('There was an error validating this address. Please try again shortly.');
                });
            },
            cancelAddressChange: function () {
                var address = this.stripe.customer.address;
                this.billing.address = {
                    line1: address.street,
                    city: address.city,
                    country: address.countryCode || '',
                    state: address.stateCode || '',
                    zip: result.address.postalCode
                }
                this.state.addressEditMode = false;
            },
            canEditAddress: function () {
                var address = this.stripe.customer.address;
                var countriesWithStates = ['US', 'CA', 'AU', 'BR', 'CN', 'IN', 'IE', 'IT', 'MX'];
                var addressEntered = (
                    address.countryCode != null &&
                    address.street != null &&
                    address.city != null &&
                    (!countriesWithStates.includes(address.countryCode) || address.stateCode != null) &&
                    address.postalCode != null
                );
                return (
                    this.state.addressEditMode || !addressEntered
                )
            },
            //------------------------------------------------------------------------------

            // *** DISCOUNT FUNCTIONS ***
            // #discount
            //------------------------------------------------------------------------------
            applyDiscountCode() {
                var $codeInput = $('#discount-code-input')
                var discountCode = $codeInput.val();
                var self = this;
                shopifyClient.checkout.addDiscount(this.checkout.checkoutId, discountCode).then(function (checkout) {
                    if (checkout.userErrors != null && checkout.userErrors.length > 0) {
                        alert('Could not apply discount code: ' + (checkout.userErrors[0].message).replaceAll('Discount code ', ''));
                        return
                    }
                    self.compileCheckout(checkout);
                    $codeInput.val('');
                });
            },
            clearDiscount: function () {
                var self = this;
                shopifyClient.checkout.removeDiscount(self.checkout.checkoutId).then(function (shopifyCheckout) {
                    if (shopifyCheckout.orderStatusUrl) {
                        alert('Could not remove discount code');
                        return
                    }
                    self.compileCheckout(shopifyCheckout);
                })
            },
            //------------------------------------------------------------------------------
            
            // *** COUNTRY/STATE SELECT FUNCTIONS ***
            // #countryselect
            getCountryIndex: function (countryCode) {
                for (var i = 0; i < this.countries.length; i++) {
                    if (this.countries[i].code == countryCode) return i + 1;
                }
            },
            renderStates: function (event, index) {
                var i = index - 1;
                var selectedCountry = this.countries[i];
                this.states = selectedCountry.states;
                this.billing.state = '';
            },
            updateRegionalInfo: function () {
                var wasImagineer = this.state.isImagineer;
                this.state.isImagineer = this.billing.address.country != 'US';
                this.state.applyVat = vatCountries.includes(this.billing.address.country);
                if (!this.stripe.customer.vatNumber) this.vat.number = '';
                this.vat.valid = false;
                this.calculateTax();
                this.calculateTotal();
            },
            //------------------------------------------------------------------------------

            // *** PAYMENT METHOD FUNCTIONS ***
            // #paymentmethod
            //------------------------------------------------------------------------------
            getPaymentIntent: function () {
                var self = this;
                if (self.checkout.paymentIntent.id != null) return Promise.resolve();
                if (self.totals.total == 0) return Promise.resolve();
                return new Promise(function (resolve, reject) {
                var data = {
                    checkoutId: self.checkout.checkoutId,
                    gatewayId: self.stripe.customer.gatewayId,
                    customerId: self.stripe.customer.stripeId,
                    amount: currency(self.totals.total).value,
                }
                axios.post('https://backend.borisfx.com/checkout/intent', data, { auth: { username: self.user.email, password: self.user.token } })
                    .then(function (res) {
                        self.checkout.paymentIntent = res.data;
                        resolve();
                    })
                    .catch(function (err) {
                        if (err.response != null && err.response.status == 403) {
                            Cookies.set('bfx-login', '', { domain: window.location.hostname == 'localhost' ? 'localhost' : '.' + window.location.hostname, expires: -1 });
                            Cookies.set('redirect_url', window.location.href);
                            window.location.href = '/account/login?session_expired=true';
                        }
                        alert('There was an error initializing checkout. Please contact us at customerservice@borisfx.com for assistance.');
                        window.location.reload();
                        reject();
                    })
                })
            },
            getCardToken: function () {
                var self = this;
                return new Promise(function (resolve, reject) {
                    self.stripe.stripeJs.createToken(self.stripe.cardElement, self.getCardTokenData()).then(function (result) {
                        if (result.error) {
                            reject('Failed to make Token');
                        }
                        resolve(result.token.id);
                    })
                });
            },
            getBankToken: function () {
                var self = this;
                var payload = {
                    publicToken: self.plaid.plaidToken,
                    accountId: self.plaid.selectedAccountId
                }
                return new Promise(function (resolve, reject) {
                    axios.post('https://backend.borisfx.com/payment/bank_token', payload)
                        .then(function (res, status) {
                            resolve(res);
                        })
                        .catch(function (err) {
                            reject('Failed to make Token');
                        });
                });
            },
            getToken: function (paymentType) {
                var self = this;
                return new Promise(function (resolve, reject) {
                    if (paymentType == 'card') token = self.getCardToken()
                        .then(function (result) {
                            if (result.error) reject(result.error);
                            resolve(result);
                        })
                        .catch(function (err) {
                            reject(err);
                        })
                    else if (paymentType == 'ach') token = self.getBankToken()
                        .then(function (result) {
                            if (result.error) reject(result.error);
                            resolve(result);
                        })
                        .catch(function (err) {
                            reject(err);
                        })
                });
            },
            initiate3dSecure: function (clientSecret) {
                var self = this;
                self.stripe.stripeJs.handleCardAction(clientSecret)
                    .then(function (res) {
                        if (res.error) {
                            alert(res.error.message);
                            self.state.submitting = false;
                            self.overlayText = 'Please Wait'
                        }
                        //Continue Processing Order
                        else {
                            var payload = self.buildOrderJson(self.billing.pmId);
                            return axios.post('https://backend.borisfx.com/checkout/intent-auth', payload);
                        }
                    })
                    .then(() => {
                        self.poll();
                    })
            },
            //------------------------------------------------------------------------------
            
            // ***NEW PAYMENT METHOD MODAL FUNCTION***
            // paymentmethodmodal
            //------------------------------------------------------------------------------
            handleNewPmModalClose: function () {
                var form = this.$refs.newCardForm;
                form.reset();
                this.stripe.cardElement.clear();
            },
            launchPlaid: function () {
                this.plaid.handler.open();
            },
            handleNewPmSubmit: function (event) {
                this.lockNewPmModal = true;
                var self = this;
                var payload = {};

                var formName = event.currentTarget.name;
                var paymentType = '';
                if (formName == 'new-card-form') {
                    paymentType = 'card';
                    $('form[name = "new-card-form"]').serializeArray().forEach(function (item) {
                        payload[item.name] = item.value;
                    });
                }
                else if (formName == 'new-ach-form') paymentType = 'ach';

                self.getToken(paymentType).then(function (result) {
                    if (result.error) {
                        self.lockNewPmModal = false;
                        return;
                    }
                    payload.token = result;
                    payload.customerId = self.stripe.customer.customerId;
                    payload.gatewayId = self.stripe.customer.gatewayId;
                    axios.post('https://backend.borisfx.com/payment_method/add', payload, { auth: { username: self.user.email, password: self.user.token } })
                        .then(function (res) {
                            self.getCustomer();
                            $('#new-pm-modal').modal('hide');
                            self.lockNewPmModal = false;
                        })
                        .catch(function (err) {
                            if (err.response && err.response.status == 403) {
                                Cookies.set('bfx-login', '', { domain: window.location.hostname == 'localhost' ? 'localhost' : '.' + window.location.hostname, expires: -1 });
                                Cookies.set('redirect_url', window.location.href);
                                window.location.href = '/account/login?session_expired=true';
                                return;
                            }
                            alert('There was an error saving this Payment Method. Please checck your provided information and try again.');
                            self.lockNewPmModal = false;
                        });
                })
                    .catch(function (err) {
                        alert('There was an error saving this Payment Method. Please checck your provided information and try again.');
                        self.lockNewPmModal = false;
                    })
            },
            //------------------------------------------------------------------------------

            // *** SUBMIT HANDLER
            // #submithandler
            //------------------------------------------------------------------------------
            handleSubmit: function () {
                var self = this;
                self.state.submitting = true;
                if (this.vat.number != '' && !this.vat.valid && this.billing.address.country != 'GB') {
                    alert('Please Verify your supplied VAT Number before submitting your order.');
                    self.state.submitting = false;
                    self.overlayText = 'Please Wait. . .'
                    return;
                }
                var payload = self.buildOrderJson(self.billing.pmId);
                //Using payload.email as username rather than email stored in cookie to ensure an email is being passed to Salesforce.
                axios.post('https://backend.borisfx.com/checkout/order', payload, { auth: { username: payload.email, password: self.user.token } })
                .then(function () { self.poll() })
            },
            completeOrder : function (order) {
                var self = this;
                var uriParams = '';
                Cookies.remove('bfx-checkout-id');
                if (order != null) {
                    self.attribution.orderid = order.orderId;
                    if (order.licenses.length > 0 && window.view_api){
                        for (var i = 0; i < order.licenses.length; i++){
                            uriParams += (i == 0 ? '/?serials[]=' + order.licenses[i].serial : '&serials[]=' + order.licenses[i].serial);
                        }
                    }
                }
                shopifyClient.checkout.removeLineItems(self.checkout.checkoutId, self.checkout.lineItems[0].id).then(function () {
                    self.captureConversion();
                    window.location.href = '/store/checkout-success' + uriParams;
                })
            },

            // *** NAVIGATION FUNCTIONS ***
            // #navigation
            //------------------------------------------------------------------------------
            goToPaymentMethods: function () {
                //calculate taxes if it has not already been done.
                var self = this;
                self.getPaymentIntent()
                .then(function(){
                    self.updateRegionalInfo();
                    if (!self.stripe.stripeJs) self.initializeStripe();
                    var billingSection = document.getElementById('billing-info-section');
                    var paymentSection = document.getElementById('payment-info-section');
                    billingSection.classList.add('slide-hide');
                    billingSection.classList.remove('slide-show');
                    paymentSection.classList.add('slide-show');
                    paymentSection.classList.remove('slide-hide');
                })
            },
            goToBillingInfo: function () {
                var billingSection = document.getElementById('billing-info-section');
                var paymentSection = document.getElementById('payment-info-section');
                paymentSection.classList.add('slide-hide');
                paymentSection.classList.remove('slide-show');
                billingSection.classList.add('slide-show');
                billingSection.classList.remove('slide-hide');
            },
            //------------------------------------------------------------------------------

            // *** CALCULATION FUNCTIONS ***
            // #calculation
            //------------------------------------------------------------------------------
            calculateTax: function () {
                var selectInput;
                var company;
                if (this.state.applyVat) {
                    if (this.vat.valid) {
                        this.totals.taxRate = 0;
                        return;
                    }
                    company = 'imagineer';
                    selectInput = document.getElementById('billing-country');
                }
                else {
                    company = 'bfx';
                    selectInput = document.getElementById('billing-state');
                }
                if (!selectInput) {
                    this.totals.taxRate = 0;
                    return;
                }
                region = selectInput.options[selectInput.selectedIndex].text;
                rate = this.taxRates[company][region];
                if (rate == null) rate = 0;
                this.totals.taxRate = rate;
            },
            calculateTotal: function () {
                var taxRate = this.totals.taxRate / 100;
                var subtotal = currency(this.totals.subtotal);
                var discount = currency(this.totals.discount);

                var tax = subtotal.subtract(discount).multiply(taxRate);

                this.totals.taxes = tax.format();
                this.totals.total = subtotal.subtract(discount).add(tax).format();
                if (this.totals.total == 0) this.billing.pmId == '';
            },
            //------------------------------------------------------------------------------

            // *** OBJECT BUILDING FUNCTIONS ***
            // #objects
            //------------------------------------------------------------------------------
            compileCheckout: function (shopifyCheckout) {
                var checkout = this.checkout;
                checkout.lineItems = shopifyCheckout.lineItems;
                var subtotal = currency(shopifyCheckout.lineItemsSubtotalPrice.amount);
                var subtotalWithDiscount = currency(shopifyCheckout.subtotalPrice.amount);

                this.totals.discount = subtotal.subtract(subtotalWithDiscount).format();
                this.totals.subtotal = subtotal.format();
                this.calculateTotal();

                if (shopifyCheckout.discountApplications.length > 0) {
                    checkout.currentDiscountCode = shopifyCheckout.discountApplications[0].code;
                    checkout.discountCodeApplicable = shopifyCheckout.discountApplications[0].applicable;
                }
                else {
                    checkout.currentDiscountCode = null;
                    checkout.discountCodeApplicable = null;
                }
            },
            buildOrderJson: function (paymentMethodId) {
                var data = {
                    date: new Date().getTime() / 1000,
                    address: this.billing.address,
                    firstName: this.billing.firstName,
                    lastName: this.billing.lastName,
                    company: this.billing.company,
                    email: this.user.email,
                    lineItems: this.checkout.lineItems,
                    discountCode: this.checkout.currentDiscountCode,
                    total: currency(this.totals.total).value,
                    amount: currency(this.totals.total).intValue,
                    invoiceFrom: this.state.isImagineer ? 'Imagineer' : 'Boris FX',
                    checkoutId: this.checkout.checkoutId,
                    gatewayId: this.stripe.customer.gatewayId,
                    isTest: this.stripe.customer.isTestGateway,
                    intent: this.checkout.paymentIntent,
                    pmId: paymentMethodId,
                    autorenew: this.autorenew
                }
                return data;
            },
            getCardTokenData: function () {
                var form = document.getElementsByName('new-card-form')[0];
                var tokenData = {};
                tokenData.address_line1 = form.address.value;
                tokenData.address_line2 = form.address2.value;
                tokenData.address_city = form.city.value;
                tokenData.address_zip = form.zip.value;
                tokenData.address_country = form.country.value;
                if (form.state != null) tokenData.address_state = form.state.value;
                tokenData.name = form.holderName.value;
                tokenData.type = 'card';
                return tokenData;
            },
            //------------------------------------------------------------------------------

            // *** BOOLEAN FUNCTIONS ***
            // #boolean
            //------------------------------------------------------------------------------
            containsUS() {
                var items = this.checkout.lineItems;
                if (items.length == 0) return false;
                var usFamilies = ['Sapphire', 'Continuum', 'Mocha Pro', 'Silhouette', 'Optics'];
                for (var item of items) {
                    var productFamily = item.title.toLowerCase();
                    if (!productFamily.includes('bundle') && !productFamily.includes(usFamilies)) continue;
                    var variantSplit = item.variant.title.split(' / ');
                    var variant = variantSplit[variantSplit.length - 1].trim().toLowerCase();
                    if (variant == 'new license' || variant == 'upgrade/support renewal') return true;
                }
                return false;
            },
            //------------------------------------------------------------------------------

            // *** POLLING FUNCTIONS ***
            // #polling
            //------------------------------------------------------------------------------
            poll: function () {
                var self = this;
                var uri = 'https://backend.borisfx.com/checkout/poll?id=' + encodeURIComponent(self.checkout.checkoutId)
                return new Promise((resolve, reject) => {
                    axios.get(uri)
                        .then((res) => {
                            if (res.data.status != null) self.status = res.data.status;
                            self.overlayText = self.statusLabels[self.status];
                            if (self.pollingCompleteStatuses.includes(self.status)) {
                                self.handlePollingResponse(res.data);
                                return resolve();
                            }
                            else if (self.pollingErrorStatuses.includes(self.status)){
                                self.handlePollingError(res.data);
                            }
                            else {
                                setTimeout(self.poll, 2000);
                            }
                        })
                })
            },
            handlePollingResponse: function (data) {
                var self = this;
                if (self.status == '3dsecure required') {
                    self.initiate3dSecure(data.intentClientSecret);
                }
                else if (self.status == 'complete' || self.status == 'fulfillment failed') {
                    self.completeOrder(data.order);
                }
            },
            handlePollingError: function(data) {
                var self = this;
                switch(self.status){
                    case 'init failed':
                        alert('Order failed to initialize. Please review your information and try again.');
                        break;
                    case 'payment failed':
                        alert('We were unable to process your payment. Please review your information and try again.\n\nError: ' + data.error);
                        break;
                }
                self.state.submitting = false;
                self.overlayText = 'Please Wait'
            },
            //------------------------------------------------------------------------------

            // *** CONVERSION TRACKING FUNCTIONS ***
            // #conversiontracking
            //------------------------------------------------------------------------------
            captureConversion: function () {
                var self = this;
                try {
                    self.googleAnalyticsInit();
                    self.addGAProducts();
                    self.addGAConversion();
                    self.addGASendPageview();
                    self.addGTMConversion();
                } catch (err){}
            },
            googleAnalyticsInit: function () {
                var gaKey = window["GoogleAnalyticsObject"] || "ga";
                this.ga = window[gaKey] || function () {
                    (window[gaKey]["q"] = window[gaKey]["q"] || []).push(arguments);
                };
                window[gaKey] = ga;
            },
            addGAProducts: function () {
                try {
                    var self = this;
                    var ga = self.ga;
                    var checkout = self.checkout;
                    var thisorderid = this.attribution.orderid;
                    var countLineItems = checkout.lineItems.length;
                    var itrLineItems = 0;
                    for (itrLineItems = 0; itrLineItems < countLineItems; ++itrLineItems) {
                        var thisLineItem = {
                            'id': checkout.lineItems[itrLineItems].variant.sku,
                            'name': checkout.lineItems[itrLineItems].title + " / " + checkout.lineItems[itrLineItems].variant.title,
                            'category': checkout.lineItems[itrLineItems].title + " / " + checkout.lineItems[itrLineItems].variant.title,
                            'brand': 'BorisFX',
                            'variant': checkout.lineItems[itrLineItems].variant.title,
                            'price': checkout.lineItems[itrLineItems].variant.priceV2.amount,
                            'quantity': checkout.lineItems[itrLineItems].quantity
                        };
                        ga(function () {
                            ga.getAll().forEach(function (t) {
                                ga(t.get("name") + ".ec:addProduct", thisLineItem);
                            });
                        });
                    }
                }
                catch (err) { console.error(err); }
            },
            addGAConversion: function () {
                try {
                    var self = this;
                    var ga = self.ga;
                    var checkout = self.checkout;
                    var thisTotal = this.totals.total;
                    var thisTax = this.totals.taxes;
                    var thisorderid = this.attribution.orderid;
                    var thisPurchase = {
                        'id': thisorderid,
                        'affiliation': 'Webshop',
                        'revenue': thisTotal,
                        'tax': thisTax,
                        'shipping': 0,
                        'coupon': self.currentDiscountCode,    // User added a coupon at checkout.
                        'list': 'borisfx-com-purchase'
                    };
                    ga(function () {
                        ga.getAll().forEach(function (t) {
                            ga(t.get("name") + ".ec:setAction", 'purchase', thisPurchase);
                        });
                    });
                }
                catch (err) { console.error(err); }
            },
            gtmCheckoutEvent: function (lineItems, step) {
                var self = this;
                try {
                    var products = [];
                    for (var li of lineItems) {
                        var titleSplit = li.variant.title.split(' / ');
                        var host = titleSplit.length == 2 ? titleSplit[0] : null;
                        var type = titleSplit.length == 2 ? titleSplit[1] : titleSplit[0];

                        products.push({
                            'name': li.variant.product.title,
                            'id': li.variant.sku,
                            'price': li.variant.price.amount,
                            'category': host ? host.replaceAll('/', ' + ') : null,
                            'variant': type,
                            'quantity': li.quantity
                        });
                    }

                    dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
                    dataLayer.push({
                        'event': 'checkout',
                        'ecommerce': {
                            'checkout': {
                                'actionField': { 'step': step },
                                'products': products
                            }
                        }
                    });
                }
                catch (err) {
                    console.error(err);
                }
            },
            addGTMConversion: function () {
                var dataLayer = window.dataLayer = window.dataLayer || [];
                try {
                    var self = this;
                    var ga = self.ga;
                    var checkout = self.checkout;
                    var thisTotal = this.totals.total;
                    var thisTax = this.totals.taxes;
                    var thisorderid = this.attribution.orderid;

                    var products = [];
                    for (var li of checkout.lineItems) {
                        var titleSplit = li.variant.title.split(' / ');
                        var host = titleSplit.length == 2 ? titleSplit[0] : null;
                        var type = titleSplit.length == 2 ? titleSplit[1] : titleSplit[0];

                        products.push({
                            'name': li.variant.product.title,
                            'id': li.variant.sku,
                            'price': li.variant.price.amount,
                            'category': host ? host.replaceAll('/', ' + ') : null,
                            'variant': type,
                            'quantity': li.quantity
                        });
                    }

                    dataLayer.push({ 'ecommerce': null })
                    dataLayer.push({
                        'event': 'purchase',
                        'ecommerce': {
                            'purchase': {
                                'actionField': {
                                    'id': thisorderid,            // Transaction ID. Required for purchases and refunds.
                                    'affiliation': 'Webshop',
                                    'revenue': thisTotal,          // Total transaction value (incl. tax and shipping)
                                    'tax': thisTax,
                                    'shipping': 0,
                                    'coupon': self.currentDiscountCode
                                },
                                'products': products
                            }
                        }
                    });
                }
                catch (err) {
                    console.error(err);
                }
            },
            addGASendPageview: function () {
                var self = this;
                var ga = self.ga;
                var checkout = self.checkout;
                try {
                    ga.getAll().forEach(function (t) {
                        ga(t.get("name") + ".send", 'pageview');
                    });
                }
                catch (err) { }
            },
            addPardotConversion: function () {
                //Pardot Form Handlers don't accept ajax post requests due to CORS issues. Instead, a form submit must be simulated through DOM manipulation.
                var form = document.createElement('form');
                form.setAttribute('method', 'post');
                form.setAttribute('action', ' https://go.pardot.com/l/272832/2020-08-18/8fjt71');
                var billing = this.billing,
                    address = billing.address;

                var conversionData = {
                    checkout_email: billing.email,
                    checkout_billing_address_first_name: billing.firstName,
                    checkout_billing_address_last_name: billing.lastName,
                    checkout_billing_address_company: billing.company,
                    checkout_billing_address_address1: address.line1,
                    checkout_billing_address_address2: address.line2,
                    checkout_billing_address_city: address.city,
                    checkout_billing_address_country: address.country,
                    checkout_billing_address_province: address.state,
                    checkout_billing_address_zip: address.zip,
                    checkout_billing_address_phone: ''
                };

                for (var key of Object.keys(conversionData)) {
                    var input = document.createElement('input');
                    input.setAttribute('type', 'text');
                    input.setAttribute('name', key);
                    input.setAttribute('value', conversionData[key] || '');
                    form.appendChild(input);
                }
                document.body.appendChild(form);
                form.submit();
            },
            //------------------------------------------------------------------------------

            // *** MISCELANEOUS FUNCTIONS ***
            // #misc
            //------------------------------------------------------------------------------
            getCustomer: function () {
                var self = this;
                if (!self.user) return;
                return new Promise(function (resolve, reject) {
                    axios.get('https://backend.borisfx.com/stripe_customer', { auth: { username: self.user.email, password: self.user.token } })
                        .then(function (res) {
                            if (res == null) {
                                resolve();
                                return;
                            }
                            result = res.data;
                            if (result.customerId) {
                                self.stripe.customer = result;
                                self.billing = {
                                    firstName: result.firstName,
                                    lastName: result.lastName,
                                    email: result.email,
                                    company: result.company,
                                    address: {
                                        line1: result.address.street,
                                        city: result.address.city,
                                        country: result.address.countryCode || '',
                                        zip: result.address.postalCode
                                    },
                                    pmId: ''
                                }
                                if (self.billing.address.country != '') {
                                    var countryIndex = self.getCountryIndex(self.billing.address.country);
                                    self.renderStates(null, countryIndex);
                                    self.billing.address.state = result.address.stateCode || '';
                                }
                                self.stripe.customer.hasSavedCards = result.cards.length > 0;

                                self.stripe.customer.hasSavedAddress = Object.keys(result.address).length > 0 && result.address.countryCode != null;
                                if (!self.vat.valid) {
                                    self.vat.number = result.vatNumber || '';
                                }
                                if (self.stripe.customer.isTestGateway == null) self.stripe.customer.isTestGateway = false;
                            }
                            resolve();
                        })
                        .catch(function (err) {
                            reject(err);
                        })
                })
            },
            validateVAT: function () {
                var self = this;
                var data = {
                    userId: self.stripe.customer.accountId,
                    userType: 'Contact',
                    number: self.vat.number,
                    country: self.billing.address.country
                };
                axios.post('https://backend.borisfx.com/checkout/check_vat', data)
                    .then(function (res) {
                        var result = res.data;
                        if (result.error == 'INVALID_INPUT') {
                            self.vat.error = 'Invalid VAT Number. Please check your formatting.';
                        }
                        else if (result.error) {
                            alert('Unable to verify VAT number. Please try again in a few minutes.');
                        }
                        else {
                            self.vat.valid = result.valid;
                            if (result.valid) self.vat.number = result.vatNumber
                            self.vat.error = self.vat.valid ? undefined : 'No match found for given VAT Number. Please confirm your info and try again. (Tip: try removing your country code and any special characters)';
                        }
                        self.calculateTax()
                        self.calculateTotal()
                    });
            },
            //------------------------------------------------------------------------------
        },
        computed: {
            submitLabel: function () {
                if (this.state.submitting) return 'Submitting';
                else if (this.totals.total <= 0) return 'Submit Order';
                else return 'Submit Payment';
            },
            pollingCompleteStatuses: function (){
                return ['complete', '3dsecure required', 'fulfillment failed'];
            },
            pollingErrorStatuses: function (){
                return ['init failed', 'payment failed'];
            },
            statusLabels : function () {
                return {
                    'initializing' : 'Initializing Order',
                    'processing payment' : 'Processing Payment',
                    'fulfilling' : 'Fulfilling Order',
                    '3dsecure required' : 'Additional Action Required',
                    'complete' : 'Order Complete!',
                    'fulfillment failed' : 'Order Complete!',
                    'init failed' : 'Initialization Error',
                    'payment failed' : 'Payment Failed'
                }
            }
        }
    });
</script>