{{ define "content" }}

<script>
var videos = [
  {{ range .Data.Pages }}
  {{ if not .Params.live }}    
  {
    "title": "{{ .Title }}",
    {{ if .Date }}"date": "{{ .Date }}",{{ end }}
    {{ if .PublishDate }}"date": "{{ .PublishDate }}",{{ end }}
    "url": "{{ .Permalink }}",
	"video_id": "{{ .Params.video_id }}",	
	"video_name": "{{ .Params.video_name }}",
    "thumbnail_url": "{{ .Params.thumbnail_url }}",
	"tags": "{{ .Params.tags }}",
    {{ if .Params.tagging }}"tagging": {{ .Params.tagging }},{{ end }}
    "content": "{{ .Content | plainify }}",
  },
  {{ end }}
  {{ end }}
];

</script>

<script type="text/javascript" src="/slick.min.js"></script>

<script>
$(document).ready(function() {

$("img#sapphire").hover(function() {
$("img#sapphire").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Sapphire_bar.png');
}, function() {
$("img#sapphire").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Sapphire.png');
});
$("img#continuum").hover(function() {
$("img#continuum").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Continuum_bar.png');
}, function() {
$("img#continuum").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Continuum.png');
});
$("img#mocha").hover(function() {
$("img#mocha").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Mocha_bar.png');
}, function() {
$("img#mocha").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Mocha.png');
});
$("img#si").hover(function() {
$("img#si").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Si_bar.png');
}, function() {
$("img#si").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Si.png');
});
$("img#pi").hover(function() {
$("img#pi").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Pi_bar.png');
}, function() {
$("img#pi").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Pi.png');
});
$("img#optics").hover(function() {
$("img#optics").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Optics_bar.png');
}, function() {
$("img#optics").attr('src', 'https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/optics.png');
});
});
</script>
<style>
.slick-slide {
    margin: 0 10px;
}
.slick-list {
    margin: 0 -10px;
}
.slick-prev:before {
  color: #0ab0f6;
}
.slick-next:before {
  color: #0ab0f6;
}

</style>



<style>
[v-cloak] {
  display: none;
}
</style>

<div id="app" v-cloak>
<div class="container">
  <div class="row">
    <div class="col-lg-3 mb-3" >
	  <div style="position: sticky; top: 115px">
      <input v-model="searchText" type="search" placeholder="Search" class="form-control mb-1" />
      <div class="mb-3">
        <p style="font-size: 10px; font-weight: bold">
          [[[ filtered_videos.length ]]] VIDEO<template v-if="filtered_videos.length != 1">S</template> FOUND.
          [[[ selected_tag_count ]]] TAG<template v-if="selected_tag_count != 1">S</template> SELECTED.
        </p>
      </div>
      <div id="tagging">
        <template v-for="category in categories">
          <h4>
            <a data-toggle="collapse" data-parent="#tagging" :href="'#' + category">
              [[[ category | capitalize ]]] <i class="fa fa-caret-down"></i>
            </a>
          </h4>
          <div :id="category" class="collapse" :class="{ show: (categories.length == 1) || (selectedTags[category].length != 0) }">
            <div v-for="tag in tags[category]" class="form-check">
              <label class="form-check-label ml-3" style="font-size: 16px">
                <input v-model="selectedTags[category]" :value="tag" type="checkbox" class="form-check-input" /> [[[ tag ]]]
              </label>
            </div>
          </div>
        </template>
      </div>
    </div>
	</div>
    <div class="col-lg-9 mb-3">
      <template v-if="filtered_videos.length == 0">
        <p class="text-center">
          No videos found.
        </p>
      </template>
      <template v-else>


  <div class="row" id="vbp">
  <div class="col-12">
          <h2 style="font-style: normal;font-weight: 500;text-align:left; letter-spacing:0em;"><b>VIDEOS BY PRODUCT</b></h2>
  </div>
  </div>
  <div class="row" id="vbp">
  <div class="col-2 col-md-1">
  <a href="/videos/?tags=product:Sapphire&search=" id="sapph"><img width="100%" height="100%" class="img-fluid" id="sapphire" src="https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Sapphire.png"></a>
  </div>
  <div class="col-2 col-md-1">
  <a href="/videos/?tags=product:Continuum&search=" id="cont"><img width="100%" height="100%" class="img-fluid" id="continuum" src="https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Continuum.png"></a>
  </div>
  <div class="col-2 col-md-1">
  <a href="/videos/?tags=product:Mocha%20Pro&search=" id="mocha"><img width="100%" height="100%" class="img-fluid" id="mocha" src="https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Mocha.png"></a>
  </div>
  <div class="col-2 col-md-1">
  <a href="/videos/?tags=product:Silhouette&search=" id="si"><img width="100%" height="100%" class="img-fluid" id="si" src="https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Si.png"></a>
  </div>
  <div class="col-2 col-md-1">
  <a href="/videos/?tags=product:Particle%20Illusion&search=" id="pi"><img width="100%" height="100%" class="img-fluid" id="pi" src="https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/Pi.png"></a>
  </div> 
  <div class="col-2 col-md-1">
  <a href="/videos/?tags=product:Optics&search=" id="optics"><img width="100%" height="100%" class="img-fluid" id="optics" src="https://borisfx-com-res.cloudinary.com/image/upload/v1613069445/icons/optics.png"></a>
  </div>
  </div>
  <br>
  <div class="row">
  <div class="col-12">
          <h2 style="font-style: normal;font-weight: 500;text-align:left; letter-spacing:0em;" id="fv"><b>FEATURED VIDEOS SERIES</b></h2>
  </div>
  </div>
  <div class="row">
    <div class="col-lg-12 mb-3">
	  <div class="slider">

  {{ range  (.Site.GetPage "Section" "free-training").Pages }}
<div class="col-12 col-md-4" style="background-color:white;padding-right:5px;padding-left:5px;font-size:11pt;font-weight:normal;">
          <div class="video" style="padding-right:0px;padding-left:0px;">
		  <a href="{{ .Params.training_url }}"><img src="{{ .Params.thumbnail_image_url }}" width="100%" height="100%"></a>
		  </div>
		 <!-- <div class="txtOVERLAY" style="color:white;margin-left:15px;font-weight:bold;">
		    <p>${ video.title }</p>
		  </div> -->
         <p style="padding-right:10px;padding-left:10px;">{{ .Params.thumbnail_blurb | markdownify }}</p><p style="padding-right:10px;padding-left:10px;">{{ .Params.thumbnail_bullet | markdownify }}</p>

</div>
 {{ end }}
	 </div>
    </div>
  </div>

           <div class="row">
		     <div class="col-12">
          <h2 style="font-style: normal;font-weight: 500;text-align:left; letter-spacing:0em;"><b>LATEST VIDEOS</b></h2>
             </div>
          <template v-for="(video, index) in filtered_videos">
				<div class="col-md-4" v-if="(index >= offset && index < (offset + page_size))">
              <div class="img-16x9" :id="video.video_name">
                <a :href="video.url">
				<div id="imgContainer" style="position:relative;height:100%;width:100%;">
                  <img :id="video.video_name" class="img-fluid w-100 h-100" loading="lazy" :src="video.thumbnail_url" />
                <!--  <img id="play" class="img-fluid" style="display:none;" loading="lazy" :name="video.video_name" src="https://borisfx-com-res.cloudinary.com/image/upload/w_50,h_50/v1600811322/blue_button._pause.png" /> -->
                </div>
				</a>
                <a :href="video.url" class="w-100 h-100">
                  <div class="w-100 h-100 video-rollover">
                    <p class="p-3" v-html="$options.filters.truncate(video.content)">
                    </p>
                  </div>
                </a>
              </div>
              <p style="font-size: 14px">
                [[[ video.title ]]] 
              </p>     
			  <input type="hidden" :value="video.video_name" style="font-size: 14px" :id="video.video_name" state="" :sid="video.video_id">

            </div>
          </template>
        </div>
		 <div class="row m-3">
          <div class="col">
            <nav class="pagination justify-content-center">
              <div class="page-item">
                <a class="page-link" href="" @click="prev"><i class="fa fa-arrow-left"></i></a>
              </div>
              <div class="page-item disabled">
                <a class="page-link" href="#">
                  Page [[[ (offset + page_size) / page_size ]]] of [[[ Math.max(Math.ceil(filtered_videos.length / page_size), 1) ]]]
                </a>
              </div>
              <div class="page-item">
                <a class="page-link" href="" @click="next"><i class="fa fa-arrow-right"></i></a>
              </div>
            </nav>
          </div>
        </div>
		
      </template>
    </div>
  </div>
</div>
</div>
<script>

var categories = [];
var tags = {};
var selectedTags = {};

for (var v in videos) {
  var video = videos[v];
  if (!video.tagging) {
    continue;
  }
  for (var c in Object.keys(video.tagging)) {
    var series = Object.keys(video.tagging)[c];
    if (!tags[series]) {
      categories.push(series);
      tags[series] = [];
      selectedTags[series] = [];
    }
    if (typeof video.tagging[series] == 'string') {
      var tag = video.tagging[series];
      if (tag != '' && tags[series].indexOf(tag) == -1) {
        tags[series].push(tag);
      }
    }
    else {
      for (var t in video.tagging[series]) {
        var tag = video.tagging[series][t];
        if (tag != '' && tags[series].indexOf(tag) == -1) {
          tags[series].push(tag);
        }
      }
    }
  }
}

for (var c in Object.keys(tags)) {
  var series = Object.keys(tags)[c];
  tags[series].sort();
}
categories.sort();

// HACK force ordering of categories in videos section
if (window.location.pathname == '/videos/') {
  categories = [
    'product',
    'series',
    'feature',
    'host',
    'language',
  ];
}

// set search and select tags from query params
var queryParamTags = getQueryParameter('tags') || '';
queryParamTags = queryParamTags.split(',');
for (var q in queryParamTags) {
  var category = queryParamTags[q].split(':')[0];
  var tag = queryParamTags[q].split(':')[1];
  if (category && tag) {
    selectedTags[category].push(tag);
  }
}
var queryParamSearch = getQueryParameter('search') || '';
var searchText = queryParamSearch;

function updateQuery() {
  var selectedTagsString = '';
  var values = [];
  var firstTag = true;
  for (var c in Object.keys(this.selectedTags)) {
    var category = Object.keys(this.selectedTags)[c];
    for (var t in this.selectedTags[category]) {
      var tag = this.selectedTags[category][t];
      if (!firstTag)
        selectedTagsString += ',';
      else
        firstTag = false;
      selectedTagsString += category + ':' + tag;
    }
  }
   // $(".slider").attr('style', 'display:none;');
 // $("#fv").attr('style', 'display:none;');  
 // $("div#vbp").attr('style', 'display:none;');
  var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?tags=' + selectedTagsString + '&search=' + this.searchText;
  window.history.pushState({path:newurl},'',newurl);
}

new Vue({

  el: '#app',
  delimiters: ['[[[', ']]]'],

  data: {
    searchText: searchText,
    categories: categories,
    tags: tags,
    selectedTags: selectedTags,
    offset: 0,
	page_size: 21,
    videos: videos,
    products: [],
    login: Cookies.getJSON('bfx-login')
  },

  mounted: function(){
    this.fetchProducts();

	$('.slider').not('.slick-initialized').slick({
  dots: false,
  infinite: true,
  speed: 300,
  slidesToShow: 3,
  slidesToScroll: 3,
  responsive: [
    {
      breakpoint: 1024,
      settings: {
        slidesToShow: 3,
        slidesToScroll: 3,
        infinite: true,
        dots: true
      }
    },
    {
      breakpoint: 800,
      settings: {
        slidesToShow: 2,
        slidesToScroll: 2
      }
    },
    {
      breakpoint: 480,
      settings: {
        slidesToShow: 1,
        slidesToScroll: 1
      }
    }
  ]
});	
  },

  computed: {

    filtered_videos: function () {

      this.offset = 0;

      function formatSearchText(searchText) {
        return searchText.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
      }
      var searchText = formatSearchText(this.searchText);

      var result = [];
      for (var v in this.videos) {
        var video = this.videos[v];

        var matches_tags = true;
        for (var c in Object.keys(this.selectedTags)) {
          var category = Object.keys(this.selectedTags)[c];
          var matches_category = false;
          if (this.selectedTags[category].length == 0) {
            matches_category = true;
          }
          for (var t in this.selectedTags[category]) {
            var tag = this.selectedTags[category][t];
            if (
              video.tagging &&
              video.tagging[category] &&
              (
                video.tagging[category].indexOf(tag) != -1 ||
                video.tagging[category] == tag
              )
            ) {
              matches_category = true;
            }
          }
          if (!matches_category) {
            matches_tags = false;
            break;
          }
        }

        var matches_search = (
          video.title.search(new RegExp(searchText, 'i')) != -1 ||
          video.content.search(new RegExp(searchText, 'i')) != -1
        );

        if (matches_tags && matches_search) {
          result.push(video);
        }

      }

      result.sort(function (a, b){
        a = new Date(a.date),
        b = new Date(b.date);
        if (a < b) return 1;
        if (a > b) return -1;
        return 0;
      });

      return result;

    },


    selected_tag_count: function() {
      var values = [];
      for (var c in Object.keys(this.selectedTags)) {
        var category = Object.keys(this.selectedTags)[c];
        Array.prototype.push.apply(values, this.selectedTags[category]);
      }
      return [].concat.apply([], values).length;
    },

  },

  watch: {

    selectedTags: {
      handler: updateQuery,
      deep: true,
    },
    searchText: {
      handler: updateQuery,
      deep: true,
    },  

  },
	updated() {
	$('.slider').not('.slick-initialized').slick({
  dots: false,
  infinite: true,
  speed: 300,
  slidesToShow: 3,
  slidesToScroll: 3,
  responsive: [
    {
      breakpoint: 1024,
      settings: {
        slidesToShow: 3,
        slidesToScroll: 3,
        infinite: true,
        dots: true
      }
    },
    {
      breakpoint: 800,
      settings: {
        slidesToShow: 2,
        slidesToScroll: 2
      }
    },
    {
      breakpoint: 480,
      settings: {
        slidesToShow: 1,
        slidesToScroll: 1
      }
    }
  ]
});	
	},
  methods: {

    prev: function (e) {
      e.preventDefault();
      if (this.offset > 0) {
        this.offset -= this.page_size;
      }
    },
    next: function (e) {
      e.preventDefault();
      if (this.offset < this.filtered_videos.length - this.page_size) {
        this.offset += this.page_size;
      }
    },
    fetchProducts: function(){
      var self = this;
      self.products = [];
      if (!self.login) return;

      var options = {auth: {username : self.login.email, password: self.login.token}};
      axios.get('https://backend.borisfx.com/training', options)
      .then(function(res){
        self.products = res.data;
      })
      .catch(function(err){
        if (err.response != null && err.response.status == 403) {
          Cookies.set('bfx-login', '', { domain: window.location.hostname == 'localhost' ? 'localhost' : '.' + window.location.hostname , expires: -1});
          Cookies.set('redirect_url', window.location.href);
          window.location.href = '/account/login?session_expired=true';
        }
        else{
          console.error('Failed to retrieve training products: ' + err.response);
        }
      })
    },
	filtered_videos_icon: function (sf) {

      this.offset = 0;
	 
      var result = [];
      for (var v in this.videos) {
        var video = this.videos[v];

        var matches_search = (
          video.title.search(new RegExp(sf, 'i')) != -1 ||
          video.content.search(new RegExp(sf, 'i')) != -1
        );

        if (matches_search) {
          result.push(video);
        }

      }

      result.sort(function (a, b){
        a = new Date(a.date),
        b = new Date(b.date);
        if (a < b) return 1;
        if (a > b) return -1;
        return 0;
      });

      return result;

    },	

  },

  filters: {
    capitalize: function (value) {
      return value.charAt(0).toUpperCase() + value.slice(1)
    },
    truncate: function(string) {
      return string.substring(0, 150) + '...';
    },    
  },

});
</script>

{{ end }}